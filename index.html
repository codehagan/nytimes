<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NYTimes</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
  <div class="nytimes">
    <embed id="dailypaper"
      src="" 
      alt="NYTimes"
      type="application/pdf"
      onError='previousDay(this)'
    />
  </div>
  <script>
    // TODO: error handling

    // TODO:  use url history to change url and load page on demand
    // instead of 'injecting' it.


    // starts after page is fully loaded
    window.addEventListener("load", function(){
      const NEWSPAPER_UPDATE_HOUR = 5; // 5:00am
      
      var d = new Date();
      var hour = d.getHours();
      var minutes = d.getMinutes();

      // retrieving previous day paper: new paper may not be available before 5am
      if(hour < NEWSPAPER_UPDATE_HOUR) {
        d.setDate(d.getDate() - 1);
      }

      //if dailypaper src = "" load paper now (aka first load)
      if(document.getElementById("dailypaper").getAttribute("src") == ""){
        console.log("dailypaper src empty, loading initial paper...")
        dailyNews(paperDate(d));
      }else{
        console.log("dailypaper src NOT empty, loading new paper...");
      }
      
      //determine setTimeout interval between now and 5am
      var hoursToNewPaper = NEWSPAPER_UPDATE_HOUR - hour;
      hoursToNewPaper = (hoursToNewPaper < 0) ? hoursToNewPaper + 24 : hoursToNewPaper;
      var milSecToNewPaper = (hoursToNewPaper * 3600000) - (minutes * 60000);
      
      // add one day for next setTimeout ( nextDaysPaper )
      d.setDate(d.getDate() + 1);
      console.log(" => dailyNews("+ paperDate(d) +"), "+milSecToNewPaper+");");
      setTimeout(() => dailyNews(nextDaysPaper(d)), milSecToNewPaper);
      //setTimeout(() => dailyNews("2020/04/01"), 9000);
      
      // milliseconds to hours minutes
      // https://www.daftlogic.com/projects-convert-milliseconds-to-hours-minutes-seconds.htm
      

    });

    // d = date to format to paperDate
    function paperDate(d){
      var year = d.getFullYear();
      var month = d.getMonth()+1;
      var day = d.getDate();
      // returns something like 2020/05/12
      return year + "/" + addZero(month) + "/" + addZero(day);
    }

    function addZero(i) {
      console.log("i: " + i);
      return (i < 10) ? i = "0" + i : i;
    }

    function dailyNews(date){
      console.log("dailyNews("+date+")");
      var leadingURL = "https://static01.nyt.com/images/";
      var trailingURL = "/nytfrontpage/scan.pdf#view=fit&toolbar=0&statusbar=0&navpanes=0";
      var paper = document.getElementById("dailypaper");
      paper.setAttribute("src", leadingURL+date+trailingURL);

      // additional pdf parameters
      //...scan.pdf#view=fit&toolbar=0&statusbar=0&navpanes=0
    }


    // TODO:  catch 404 page -> reload previous paper -> add new setTimeout(for one hour)
    function previousDay(source){
      console.log("ERORRRR!!!!");
      /*if(source.onerror){
        console.log("ERROR!!!!!");
      } else {
        console.log('GTG');
      */
      source.setAttribute("src", "https://static01.nyt.com/images/2020/04/02/nytfrontpage/scan.pdf");
      //source.onerror = "";
      return true;
      
    }

    // verify new page available
    //setTimeout(() => dailyNews("2020/05/05"), 9000);

  </script>
  
</body>
</html>